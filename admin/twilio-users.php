<?phpif ( ! defined( 'ABSPATH' ) ) {	exit; // Exit if accessed directly}class POD_Twilio_Admin_Twilio_Users extends POD_Twilio_Admin {		/**	*	@var instance of POD_Twilio_User 	*	@private	**/		private $_user;		/*	*	@var array	*	@private	*	all twilio users from twilio user table	*/	private $_twilio_users;		/* 	*	@var integer	*	@private	*	paginate number	*/	private $_pagenum;		/*	*	@var string	*	@private	*	which section to load i.e. all users/ single user detail/ user logs	*/	private $_section;		/*	*	@var integer	*	@private	*	user id 	*/	private $_id;		/*		*	@array	*	@private	*	user details of of provided user id	*/	private $_user_details;			/**	*	@array	*	@private	*	user details fields	**/	private $_user_details_fields;		/**	*	@var instance of POD_Twilio_Supported_Countries 	*	@private	**/		private $_country;		/**	*	constructor of this class	**/		function __construct(){			parent::__construct();				$this->_limit = apply_filters( "pod_twilio_admin_user_limit", 20 );		$this->_pagenum = isset( $_GET['pagenum'] ) ? absint( $_GET['pagenum'] ) : 1;						if( isset( $_GET["id"] ) && ! empty( $_GET["id"] )&&  $_GET["id"] != "" ){			$this->_id =  $_GET["id"];						if( isset( $_POST["update_user_details"] ) ){				if( pod_verify_nonce("pod_twilio_update_user_details") ){					$postdata = array_filter( $_REQUEST["twilio_user"] );					$updated = $this->update_user_details( $this->_id , $postdata);					$this->_message = $updated["message"];					$this->_message_type = $updated["status"];				}			}			$this->_user = new POD_Twilio_User( $this->_id );						$this->_user_details = $this->_user->twilio_user_details;			$this->_user_details_fields = $this->_set_user_details_fields();		}		else{			$this->_twilio_users = $this->get_twilio_users( $this->_limit, $this->_pagenum );		}		$this->_country = new POD_Twilio_Supported_Countries();		$this->get_section();			}		/**    * get the section to be displayed    * @param null    * @return void    **/	private function get_section(){		if(isset($this->_id)){			if( isset( $_GET["action"] ) && $_GET["action"] == "view_logs" ){				$this->_section = "view_logs";			}			else{				$this->_section = "single_user";			}		}		else{			$this->_section = "all_users";		}	}		/**    * load section to be displayed    * @param null    * @return void    **/	public function load_user_info_section(){		if( $this->_section == "single_user" ){			$this->show_single_user_details();				}		else if( $this->_section == "view_logs" ){			$user_logs = new POD_Twilio_Admin_User_Logs( $this->_id );						$user_logs->load_user_logs_view();		}		else{						$this->show_all_users();		}	}		/**    * show twilio user list    * @param null	* uses $_twilio_users    * @return void    * @since 1.0.0    **/	private function show_all_users(){?>		<div class="wrap">			<h1><?php esc_html_e( "Twilio Users", POD_TWILIO_TEXT_DOMAIN ); ?> </h1>			<table class="wp-list-table widefat fixed striped pages">				<thead>					<tr valign="top">						<th scope="row"><?php esc_html_e( "Username", POD_TWILIO_TEXT_DOMAIN ); ?></th>						<th scope="row"><?php esc_html_e( "User Phone", POD_TWILIO_TEXT_DOMAIN ); ?></th>						<th scope="row"><?php esc_html_e( "Twilio Phone", POD_TWILIO_TEXT_DOMAIN ); ?></th>						<th scope="row"><?php esc_html_e( "Country", POD_TWILIO_TEXT_DOMAIN ); ?></th>						<th scope="row"><?php esc_html_e( "Remaining Call Duration", POD_TWILIO_TEXT_DOMAIN ); ?></th>						<th scope="row"><?php esc_html_e( "Logs", POD_TWILIO_TEXT_DOMAIN ); ?></th>					</tr>				</thead>				<tbody>					<?php												$sn = ( ( $this->_pagenum - 1 ) * ( $this->_limit ) ) + 1;								foreach( $this->_twilio_users as $twilio_user_id ){									$twilio_user = new POD_Twilio_User( $twilio_user_id );					?>					<tr valign="">						<td>													<a href="<?php echo esc_url( add_query_arg( array( "id"=>$twilio_user_id ), menu_page_url( "pod_twilio_users", false ) ) ); ?>" class="row-title" data-id="<?php echo $twilio_user_id; ?>"><?php echo $twilio_user->get_user_name(); ?></a>						</td>						<td><?php echo $twilio_user->phone_number; ?></td>						<td><?php echo $twilio_user->twilio_number; ?></td>						<td><?php echo $twilio_user->user_country; ?></td>						<td><?php echo pod_twilio_format_call_duration( $twilio_user->remaining_call_duration ); ?></td>						<td><a class="button" href="<?php echo esc_url( add_query_arg( array( "id"=>$twilio_user_id, "action" => "view_logs" ), menu_page_url( "pod_twilio_users", false ) ) ); ?>"><?php esc_html_e( "View", POD_TWILIO_TEXT_DOMAIN ); ?></a></td>					</tr>					<?php } ?>				</tbody>			</table>		</div><?php		$num_of_pages = ceil( $this->_total_users / $this->_limit );		//total pages = total_users/users_per_page		pod_twilio_paginate_links($num_of_pages, $this->_pagenum);		//show pagination links	}		/**    * show single user details and update user form    * @param null	* uses $_twilio_users    * @return void    **/	private function show_single_user_details(){		/* show error or success messages on edit user*/		$this->pod_twilio_show_message();			?>		<div class="wrap">		<h1>			<?php esc_html_e( "User Details", POD_TWILIO_TEXT_DOMAIN ); ?>						<a href="<?php echo esc_url( add_query_arg( array( "id"=>$this->_id, "action" => "view_logs" ), menu_page_url("pod_twilio_users", false) ) ); ?>" title="<?php esc_attr_e( "View User Logs", POD_TWILIO_TEXT_DOMAIN ); ?>" id="view_user_logs" class="page-title-action"><?php esc_html_e( "View Logs", POD_TWILIO_TEXT_DOMAIN ); ?></a>		</h1>		<p class="about-description"><h4><?php esc_html_e( "Username: ", POD_TWILIO_TEXT_DOMAIN ); ?> <?php echo ucwords( $this->_user->get_user_name() ); ?><h4></p>		<form method="post" id="edit_user_info_from" action=""> 				<?php wp_nonce_field("pod_twilio_update_user_details"); ?>			<table class="form-table">				<?php echo apply_filters( "pod_twilio_show_user_details", $this->_show_user_details(), $this->_user_details ); ?>				<?php do_action( "pod_twilio_add_user_info_section", $this->_user_details ); ?>			</table>			<input type="hidden" name="user_id" value="<?php echo $user_details->user_id; ?>">			<?php submit_button( esc_attr__( "Save Changes", POD_TWILIO_TEXT_DOMAIN ), "primary", "update_user_details", false, array("id"=>"update_user_button")); ?>					</form>	</div><?php	}		/**    * set user details field section    * @param null    * @return array    **/	public function _set_user_details_fields(){		$fields = array(			array(				"title"	=> esc_html__( "Friendly Name:", POD_TWILIO_TEXT_DOMAIN ),				"name" 	=> "twilio_user[friendly_name]",				"type" 	=> "text",				"value"	=> $this->_user_details["friendly_name"],				"attr"	=> array()			),			array(				"title"		=> esc_html__( "Sub Account SID:", POD_TWILIO_TEXT_DOMAIN ),				"name" 		=> "twilio_sub_account_sid",				"type"		=> "label",				"value"		=> $this->_user_details["twilio_sub_account_sid"],				"attr" 		=> array()			),			array(				"title"		=> esc_html__( "Sub Account Auth Token:", POD_TWILIO_TEXT_DOMAIN ),				"name" 		=> "twilio_sub_account_auth_token",				"type" 		=> "label",				"value"		=> $this->_user_details["twilio_sub_account_auth_token"],				"attr" 		=> array()			),			array(				"title"		=> esc_html__( "Country:", POD_TWILIO_TEXT_DOMAIN ),				"name" 		=> "twilio_user[country_id]",				"type" 		=> "dropdown",				"value"		=> pod_format_array_for_dropdown( "country_id", "country_name", POD_TWILIO_SUPPORTED_COUNTRIES::get_supported_countries( "ARRAY_A" ) ),				"selected"	=> $this->_user_details["country_id"],				"attr" 		=> array()			),			array(				"title" 	=> esc_html__( "Country Code:", POD_TWILIO_TEXT_DOMAIN ),				"name" 		=> "country_code",				"type" 		=> "label",				"value" 	=> $this->_user_details["country_code"],				"attr" 		=> array()			),			array(				"title" 	=> esc_html__( "User's Phone:", POD_TWILIO_TEXT_DOMAIN ),				"name" 		=> "twilio_user[user_phone_number]",				"type" 		=> "text",				"value" 	=> $this->_user_details["user_phone_number"],				"attr" 		=> array()			),			array(				"title"		=> esc_html__( "Twilio Phone:", POD_TWILIO_TEXT_DOMAIN ),				"name" 		=> "twilio_phone_number",				"type" 		=> "label",				"value" 	=> $this->_user_details["twilio_phone_number"],				"attr" 		=> array()			),			array(				"title" 	=> esc_html__( "Twilio Phone Number Sid:", POD_TWILIO_TEXT_DOMAIN ),				"name" 		=> "twilio_phone_number_sid",				"type" 		=> "label",				"value" 	=> $this->_user_details["twilio_phone_number_sid"],				"attr" 		=> array()			),			array(				"title" 	=> esc_html__( "Country ISO Code:", POD_TWILIO_TEXT_DOMAIN ),				"name" 		=> "country_iso_code",				"type" 		=> "label",				"value" 	=> $this->_user_details["country_iso_code"],				"attr" 	=> array()			)					);		return apply_filters( "pod_twilio_user_details_fields", $fields, $this->_id, $this->_user_details );	}		private function _show_user_details(){		$show = "";		foreach( $this->_user_details_fields as $field ){			$attribs = array_filter( $field["attr"] );			$attributes = "";			foreach( $attribs as $attr_key => $attr_value ){				$attributes = $attr_key . "=\"" . $attr_value . "\"";			}			switch(  $field["type"] ){				case "text":					$show .= "<tr>						<th scope=\"row\">" . $field["title"] . "</th>						<td><input type=\"text\" name=\"". $field["name"] ."\" value=\"".$field["value"]."\" ".$attributes."></td>					</tr>";					break;				case "dropdown":					$show .= "<tr>						<th scope=\"row\">" . $field["title"] . "</th>						<td><select name=\"".$field["name"]."\" ". $attributes .">";											foreach( $field["value"] as $key=>$value ){						$selected = ( $key == $field["selected"] ) ? "selected":"";						$show .= "<option value=\"" . $key . "\" ". $selected . ">".$value."</option>";					}					$show .= "</select>";						$show .= "</tr></td>";					break;				case "checkbox":					$show .= "<tr><th scope=\"row\">" . $field["title"] . "</th>;							<td><input type=\"checkbox\" name=\"". $field["name"] ."\" value=\"".$field["value"]."\" ". $attributes ."></td>";					$show .= "</tr>";					break;				case "radio":					$show .= "<tr><th scope=\"row\">" . $field["title"] . "</th>;							<td><input type=\"radio\" name=\"". $field["name"] ."\" value=\"".$field["value"]."\" ". $attributes ."></td>";					$show .= "</tr>";					break;				case "email":					$show .= "<tr><th scope=\"row\">" . $field["title"] . "</th>;							<td><input type=\"email\" name=\"". $field["name"] ."\" value=\"".$field["value"]."\" ". $attributes ."></td>";					$show .= "</tr>";				case "tel":				case "phone":					$show .= "<tr><th scope=\"row\">" . $field["title"] . "</th>;							<td><input type=\"tel\" name=\"". $field["name"] ."\" value=\"".$field["value"]."\" ". $attributes ."></td>";					$show .= "</tr>";					break;								case "label":				case "default":					$show .= "<tr><th scope=\"row\">".$field['title']."</th>";					$show .= "<td>".$field['value']."</td></tr>";					break;			}						}		return apply_filters( "pod_twilio_user_info_fields", $show, $this->_user_details, $this->_user_details_fields );	}		/**	*	get twilio users	*	@param $limit	*	@param $pagenum	*	@return $object	*/		public function get_twilio_users( $limit, $pagenum ){		$offset = ( $pagenum - 1 ) * $limit;		$twilio_users = $this->_db->get_col( "SELECT user_id FROM ".POD_TWILIO_USERS ." AS TW_USERS INNER JOIN ".POD_USERS." AS USERS ON TW_USERS.user_id = USERS.ID ORDER BY twilio_user_id ASC LIMIT $offset,$limit" );				return apply_filters( "pod_twilio_users", $twilio_users );	}			/**	*	update user details	*	@param $user_id	*	@defaiult null	*	@return update status array	*/			public function update_user_details( $user_id , $postdata){		if( $this->_db->update( POD_TWILIO_USERS, $postdata, array( "user_id"=>$user_id ) ) ){			$success["status"] = "success";			$success["message"] = esc_html__( "User details updated successfully.", POD_TWILIO_TEXT_DOMAIN );					do_action( "pod_twilio_update_user_details", $postdata );		}		else{			$success["status"] = "error";			$success["message"] = esc_html__( "Error updating.", POD_TWILIO_TEXT_DOMAIN );							}		return apply_filters( "pod_twilio_update_user_details_message",$success, $postdata );	}}