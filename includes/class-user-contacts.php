<?phpif ( ! defined( 'ABSPATH' ) ) {	exit; // Exit if accessed directly}class POD_Twilio_User_Contacts {	/*	*	@var integer	*	@private	*	user id 	*/	private $_id;		/**	*	A reference to an instance class POD_Twilio_User.	* 	@private	* 	@var   POD_Twilio_User	*/		private $_db;		/**	*	Constructor of this class	**/		public function __construct( $user_id ){		global $wpdb;		$this->_db = $wpdb;			$this->_id = $user_id;	}		/*	*	@public	*	get user contacts	*	@param integer -> $limit 	*	@param integer -> $offset	*	@param string -> $order_by	*	@return object	**/	public function get_contacts( $limit = null, $ofset = null, $order_by = null ){		$sql = "SELECT * FROM " . POD_TWILIO_CONTACT_LIST . " WHERE  request_sender_id = " .$this->_id . " OR  request_receiver_id = " . $this->_id;				if( $order_by ){			$sql .= " " . $order_by;		}				if( $limit || $offset ){			$sql .= " LIMIT ";			if( $offset ){				$sql .= $offset.",";			}			if( $limit ){				$sql .=  $limit;			}		}				$contacts = $this->_db->get_results( $sql );				return apply_filters( "pod_twilio_get_user_contacts", $contacts, $this->_id );	}		/**	*	@public	*	get contact status for given contact	*	@return string	**/	public function get_contact_status( $contact ){		$accepted = $contact->request_accepted;		$rejected = $contact->request_rejected;		$deleted = $contact->contact_removed != "NR";				if( $deleted ){			$status = "Deleted";		}		else if( $accepted ){			if( $this->_id == $contact->request_sender_id ){				if( ! $contact->sender_caller_id_sid ){					$status = "User Verification Pending";				}				else if ( ! $contact->receiver_caller_id_sid ){					$status = "Contact Verification Pending";				}				else{					$status = "Verified";				}			}			else{				if ( ! $contact->receiver_caller_id_sid ){					$status = "User Verification Pending";				}				else if( ! $contact->sender_caller_id_sid ){					$status = "Contact Verification Pending";				}								else{					$status = "Verified";				}			}		}				else if( $rejected ){			$status = "Rejected";		}				else{			$status = "Pending";		}		return apply_filters( "pod_twilio_get_contact_status", $status );	}		/*	*	@public	*	get verified contact lists for given user	*	@param integer -> $limit 	*	@param integer -> $offset	*	@param string -> $order_by	**/	public function get_verified_contact_list( $limit = null, $offset = null, $order_by = null ){		$sql = "SELECT * FROM " . POD_TWILIO_CONTACT_LIST . " WHERE ( request_sender_id = " .$this->_id . " OR  request_receiver_id = " . $this->_id . ") AND ( sender_caller_id_sid <> '' AND sender_caller_id_sid IS NOT NULL ) AND ( receiver_caller_id_sid <> '' AND receiver_caller_id_sid IS NOT NULL ) AND request_accepted = 1 AND contact_removed = 'NR'";				if( $order_by ){			$sql .= " " . $order_by;		}				if( $limit || $offset ){			$sql .= " LIMIT ";			if( $offset ){				$sql .= $offset.",";			}			if( $limit ){				$sql .=  $limit;			}		}				$contacts = $this->_db->get_results( $sql );				return apply_filters( "pod_twili_get_verified_user_contacts", $contacts, $this->_id );	}		/*	*	@public	*	total verified contacts	*	@return integer	**/	public function total_verified_contacts(){		$sql = "SELECT COUNT( * ) FROM " . POD_TWILIO_CONTACT_LIST . " WHERE ( request_sender_id = " .$this->_id . " OR  request_receiver_id = " . $this->_id . ") AND ( sender_caller_id_sid <> '' AND sender_caller_id_sid IS NOT NULL ) AND ( receiver_caller_id_sid <> '' AND receiver_caller_id_sid IS NOT NULL ) AND request_accepted = 1 AND contact_removed = 'NR'";				$total = $this->_db->get_var( $sql );				return apply_filters( "pod_twilio_total_verified_user_contacts", $total, $this->_id );	}		/*	*	@public	*	get pending contact lists for given user	*	@param integer -> $limit 	*	@param integer -> $offset	*	@param string -> $order_by	*	@return object	**/	public function get_pending_contacts_list( $limit = null, $offset = null, $order_by = null ){		$sql = "SELECT * FROM " . POD_TWILIO_CONTACT_LIST . " WHERE ( request_sender_id = " .$this->_id . " OR  request_receiver_id = " . $this->_id . ") AND ( ( sender_caller_id_sid = '' OR sender_caller_id_sid IS NULL ) OR ( receiver_caller_id_sid = '' OR receiver_caller_id_sid IS NULL ) ) AND ( request_rejected <> 1 OR request_accepted = 1 ) AND contact_removed = 'NR'";				if( $order_by ){			$sql .= " " . $order_by;		}				if( $limit || $offset ){			$sql .= " LIMIT ";			if( $offset ){				$sql .= $offset.",";			}			if( $limit ){				$sql .=  $limit;			}		}				$contacts = $this->_db->get_results($sql);				return apply_filters( "pod_twilio_get_pending_user_contacts", $contacts, $this->_id );	}		/*	*	@public	*	total pending contacts	*	@return integer	**/	public function total_pending_contacts(){		$sql = "SELECT count( * ) FROM " . POD_TWILIO_CONTACT_LIST . " WHERE ( request_sender_id = " .$this->_id . " OR  request_receiver_id = " . $this->_id . ") AND ( ( sender_caller_id_sid = '' OR sender_caller_id_sid IS NULL ) OR ( receiver_caller_id_sid = '' OR receiver_caller_id_sid IS NULL ) ) AND ( request_rejected <> 1 OR request_accepted = 1 ) AND contact_removed = 'NR'";				$total = $this->_db->get_var( $sql );				return apply_filters( "pod_twilio_total_pending_user_contacts", $total, $this->_id );	}		/*	*	@public	*	show what action needs to be taken for given contact	*	@return string	**/	public function action_button( $contact, $contact_user ){		$contact_status =  $this->get_contact_status( $contact );		$status_btn = "";		if( $contact_status == "Pending" ){			if( $contact->request_receiver_id == $this->_id ){						$status_btn .= "<a class=\"pod-twilio-accept-request\" data-action=\"accept\" data-contact-user-id=\"".$contact_user->_id."\">" . __( "Accept", POD_TWILIO_TEXT_DOMAIN ) . "</a>				<a class=\"pod-twilio-accept-request\" data-action=\"reject\" data-contact-user-id=\"".$contact_user->_id."\">Reject</a>";			}			else{				$status_btn .= "<a class=\"action-btn pending\">" . __( "Request Sent Pending", POD_TWILIO_TEXT_DOMAIN ) . "</a>";			}		}		else if( $contact_status == "User Verification Pending" ){			$status_btn .= "<a class=\"action-btn pod-twilio-verify-number\" data-contact-user-id=\"".$contact_user->_id."\">". __( "Verify", POD_TWILIO_TEXT_DOMAIN ). "</a>";		}		else if( $contact_status == "Contact Verification Pending" ){			$status_btn .= "<a class=\"action-btn\">".__( "Verification Pending", POD_TWILIO_TEXT_DOMAIN ) . "</a>";		}		return apply_filters( "pod_twilio_pending_contact_action_btn", $status_btn, $contact_status, $contact, $contact_user );			}}