<?phpif ( ! defined( 'ABSPATH' ) ) {	exit; // Exit if accessed directly}class POD_TWilio_Users_List_Shortcode {	/**	*	A reference to an instance of this class.	* 	@private	* 	@var   POD_TWilio_User_List_Shortcode	*/	private static $_instance = null;		/*	*	@private	*	instance of global $wpdb for accessing database	*/	private $_db;			/*	*	@private	*	stores twilio users id	*/	private $_users;		/*	*	@private	*	@var integer	*	limit of users to be shown for pagination	*/	private $_limit;		/*	*	@private	*	@var integer	*	offset of pagination	*/	private $_offset;		/*	*	@private	*	@var integer	*	current page number of pagination	*/	private $_current_page;		/*	*	@private	*	@var integer	*	total pages for pagination	*/	private $_total_pages;		/**	*	Constructor of this class	*	Initializes shortcode for user register	**/			private function __construct(){		global $wpdb;		$this->_db = $wpdb;		add_shortcode( "pod-twilio-userslist", array( $this, "init_shortcode" ) );	}		/**	* Returns an instance of this class	* @public	* @return   POD_TWilio_User_Profile_Shortcode	*/	public static function init(){			if ( is_null( self::$_instance ) ) {				self::$_instance = new self();		}		return self::$_instance;	}		/**	*	Callback function of the shortcode	*	initializes the shortcode and returns shortcode content	*	@return string	**/	public function init_shortcode( $atts ){		if( isset( $_GET["pagenum"] ) && is_numeric( trim( $_GET["pagenum"] ) ) ){			$this->_current_page = $_GET["pagenum"];					}		else{			$this->_current_page = 1;		}				$attrs = shortcode_atts( array( "limit" => 10 ), $atts );				$this->_limit = $attrs["limit"];				$this->_offset = ( $this->_current_page - 1 ) * $this->_limit;				$this->_users = $this->get_twilio_users( $this->_limit, $this->_offset );				$total_users = $this->total_twilio_users();				$this->_total_pages = ceil( $total_users / $this->_limit );				do_action("pod_twilio_userslist_shortcode_init");				if( is_user_logged_in() ){			ob_start();			?>			<div id="pod-twilio-users">	<!--main div ( wrapper div of shortcode output ) -->			<?php							$this->_show_users_list();							?>			</div> <!-- close main div -->			<?php			return ob_get_clean();		}	}		/**	*	@private	*	display users list	*	@return void	**/	private function _show_users_list(){		foreach( $this->_users as $user_id ){			if( $user_id != get_current_user_id() ){				$user = new POD_Twilio_User( $user_id );				if( $user ){					if( $user->has_twilio_activated ){											$this->_show_user_details( $user );											}				}			}		}		$this->_pagination_links();	}		private function _pagination_links(){			pod_twilio_paginate_links( $this->_total_pages, $this->_current_page );	}	/**	*	@private	*	show single user details	*	@return void	**/	private function _show_user_details( $user ){	?>		<ul>			<li class="user-details">				<?php 					echo get_avatar( $user->_id, 50 ) . "&nbsp;"; 					echo $user->get_user_name();					?>					<div>						<?php echo $user->user_country; ?>									</div>			</li>			<li class="status">				<?php											$request_handler = new POD_TWilio_Contact_Request_Handler( $user->_id );									if( $request_handler->contact_exists() ){						$request_status = $request_handler->get_contact_status();						if( $request_status == "Deleted" || $request_status == "Rejected"  ){							echo apply_filters( "pod_twilio_add_contact_list_button",'<a class="pod-twilio-add-to-contact" data-user-id="'.$user->_id.'">'.apply_filters( "pod_twilio_add_to_contact_list_button_text", esc_html__( "Add to Contact", POD_TWILIO_TEXT_DOMAIN ) ).'</a>', $user );						}						else{							echo apply_filters( "pod_twilio_user_list_status_button", "<a>". __( $request_status, POD_TWILIO_TEXT_DOMAIN )."</a>", $user );						}					}					else{						echo apply_filters( "pod_twilio_add_contact_list_button",'<a class="pod-twilio-add-to-contact" data-user-id="'.$user->_id.'">'.apply_filters( "pod_twilio_add_to_contact_list_button_text", esc_html__( "Add to Contact", POD_TWILIO_TEXT_DOMAIN ) ).'</a>', $user );					} ?>			</li>		</ul>	<?php	}		/*	*	get twilio users	*	@param array $where	*	@param int $limit	*	@param int $offset	*	@param string $order_by	*	@return array	*/	public function get_twilio_users( $limit = null, $offset = null, $order_by = null ){		$sql = "SELECT user_id FROM " . POD_TWILIO_USERS . " AS TW_users INNER JOIN " . POD_USERS . " AS WP_users ON TW_users.user_id = WP_users.ID WHERE WP_users.ID<>".get_current_user_id();				if( $order_by ){			$sql .= " " . $order_by;		}				if( $limit || $offset ){			$sql .= " LIMIT ";			if( $offset ){				$sql .= $offset.",";			}			if( $limit ){				$sql .=  $limit;			}		}				$result = $this->_db->get_col( $sql );				return apply_filters( "pod_twilio_get_twilio_users", $result );	}		/*	*	get total twilio users	*	@return integer -> count of total users	*/	public function total_twilio_users(){		$sql = "SELECT count( * ) FROM " . POD_TWILIO_USERS . " AS TW_users INNER JOIN " . POD_USERS . " AS WP_users ON TW_users.user_id = WP_users.ID ";		$count = $this->_db->get_var( $sql );				return apply_filters( "pod_twilio_total_twilio_users", $count );	}}